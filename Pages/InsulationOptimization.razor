@page "/insulation-optimization"
@using ThermalCalculator.Wasm.Models
@using ThermalCalculator.Wasm.Services
@inject InsulationOptimizationService OptimizationService
@inject MaterialService MaterialService
@inject IJSRuntime JS

<PageTitle>Optimalizace tlou≈°≈•ky izolace</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <h3>Optimalizace tlou≈°≈•ky izolace</h3>
        <RadzenButton Icon="help_outline"
                     ButtonStyle="ButtonStyle.Primary"
                     Variant="Variant.Flat"
                     Click="ShowHelp"
                     Size="ButtonSize.Large"
                     title="Zobrazit n√°povƒõdu k optimalizaci"
                     Style="min-width: 40px;" />
    </RadzenStack>
    <p><strong>Ekonomick√° anal√Ωza efektivity zateplen√≠</strong></p>
    <p style="font-size: 0.9em; color: #666;">V√Ωsledky jsou orientaƒçn√≠ a nez√°vazn√©. Pro p≈ôesn√Ω n√°vrh konzultujte odborn√©ho projektanta.</p>

    <RadzenRow Gap="1rem">
        <!-- Vstupn√≠ panel -->
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="settings" />
                        <RadzenText TextStyle="TextStyle.H5" Text="Vstupn√≠ parametry" />
                    </RadzenStack>

                    <!-- V√Ωbƒõr p≈ôednastaven√Ωch materi√°l≈Ø -->
                    <RadzenFormField Text="P≈ôednastaven√Ω materi√°l:" Variant="Variant.Outlined">
                        <RadzenDropDown TValue="string"
                                       Data="@presetNames"
                                       @bind-Value="selectedPresetName"
                                       Change="@OnPresetChanged"
                                       AllowClear="true"
                                       Placeholder="Vyberte materi√°l..."
                                       Style="width: 100%;" />
                    </RadzenFormField>

                    <!-- Lambda -->
                    <RadzenFormField Text="Tepeln√° vodivost Œª (W/m¬∑K):" Variant="Variant.Outlined">
                        <RadzenNumeric TValue="double"
                                      @bind-Value="input.Lambda"
                                      Min="0.01m"
                                      Max="1.0m"
                                      Step="0.001m"
                                      ShowUpDown="false"
                                      Style="width: 100%;" />
                    </RadzenFormField>

                    <!-- Cena izolace (materi√°l) -->
                    <RadzenFormField Text="Cena materi√°lu (Kƒç/m¬≤/cm):" Variant="Variant.Outlined">
                        <RadzenNumeric TValue="double"
                                      @bind-Value="input.InsulationCostPerCm"
                                      Min="1m"
                                      Max="200m"
                                      Step="1m"
                                      ShowUpDown="false"
                                      Style="width: 100%;" />
                    </RadzenFormField>

                    <!-- Fixn√≠ n√°klady -->
                    <RadzenFormField Text="Fixn√≠ n√°klady (Kƒç/m¬≤):" Variant="Variant.Outlined">
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" Text="Le≈°en√≠, pr√°ce, lepidlo, om√≠tka" />
                        </Helper>
                        <ChildContent>
                            <RadzenNumeric TValue="double"
                                          @bind-Value="input.FixedCost"
                                          Min="0m"
                                          Max="5000m"
                                          Step="100m"
                                          ShowUpDown="false"
                                          Style="width: 100%;" />
                        </ChildContent>
                    </RadzenFormField>

                    <!-- Cena energie -->
                    <RadzenFormField Text="Cena energie (Kƒç/kWh):" Variant="Variant.Outlined">
                        <RadzenNumeric TValue="double"
                                      @bind-Value="input.EnergyCost"
                                      Min="0.5m"
                                      Max="10.0m"
                                      Step="0.1m"
                                      ShowUpDown="false"
                                      Style="width: 100%;" />
                    </RadzenFormField>

                    <!-- Pokroƒçil√© parametry -->
                    <RadzenExpander>
                        <HeaderTemplate>
                            <RadzenText TextStyle="TextStyle.Body2" Text="Pokroƒçil√© parametry" />
                        </HeaderTemplate>
                        <ChildContent>
                            <RadzenStack Orientation="Orientation.Vertical" Gap="1rem" Class="rz-mt-3">
                                <RadzenFormField Text="Rozd√≠l teplot ŒîT (¬∞C):" Variant="Variant.Outlined">
                                    <RadzenNumeric TValue="double"
                                                  @bind-Value="input.TemperatureDifference"
                                                  Min="10m"
                                                  Max="50m"
                                                  Step="1m"
                                                  Style="width: 100%;" />
                                </RadzenFormField>

                                <RadzenFormField Text="Poƒçet otopn√Ωch dn≈Ø:" Variant="Variant.Outlined">
                                    <RadzenNumeric TValue="int"
                                                  @bind-Value="input.HeatingDays"
                                                  Min="100"
                                                  Max="300"
                                                  Step="10"
                                                  Style="width: 100%;" />
                                </RadzenFormField>

                                <RadzenFormField Text="≈Ωivotnost izolace (roky):" Variant="Variant.Outlined">
                                    <RadzenNumeric TValue="int"
                                                  @bind-Value="input.LifetimeYears"
                                                  Min="10"
                                                  Max="50"
                                                  Step="5"
                                                  Style="width: 100%;" />
                                </RadzenFormField>

                                <!-- Inflace toggle -->
                                <RadzenFormField Variant="Variant.Outlined">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <RadzenCheckBox @bind-Value="input.UseInflation" Name="useInflation" />
                                        <RadzenLabel Text="Zohlednit roƒçn√≠ inflaci energie" Component="useInflation" />
                                    </RadzenStack>
                                </RadzenFormField>

                                <!-- Inflace rate - pouze pokud je zapnuto -->
                                @if (input.UseInflation)
                                {
                                    <RadzenFormField Text="Roƒçn√≠ inflace (%):" Variant="Variant.Outlined">
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" Text="Oƒçek√°van√Ω r≈Øst cen energie" />
                                        </Helper>
                                        <ChildContent>
                                            <RadzenNumeric TValue="double"
                                                          @bind-Value="input.AnnualInflationRate"
                                                          Min="0m"
                                                          Max="15m"
                                                          Step="0.5m"
                                                          ShowUpDown="false"
                                                          Style="width: 100%;" />
                                        </ChildContent>
                                    </RadzenFormField>
                                }
                            </RadzenStack>
                        </ChildContent>
                    </RadzenExpander>

                    <!-- Tlaƒç√≠tko v√Ωpoƒçtu -->
                    <RadzenButton Text="Vypoƒç√≠tat optimalizaci"
                                 Icon="calculate"
                                 ButtonStyle="ButtonStyle.Primary"
                                 Click="CalculateOptimization"
                                 Style="width: 100%;" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <!-- Graf a v√Ωsledky -->
        <RadzenColumn Size="12" SizeMD="8">
            @if (result == null)
            {
                <RadzenCard>
                    <RadzenStack Orientation="Orientation.Vertical"
                                JustifyContent="JustifyContent.Center"
                                AlignItems="AlignItems.Center"
                                Gap="1rem"
                                Style="min-height: 400px;">
                        <RadzenIcon Icon="insights" Style="font-size: 4rem;" Class="rz-color-base-400" />
                        <RadzenText TextStyle="TextStyle.H6" Text="Zadejte parametry a kliknƒõte na 'Vypoƒç√≠tat optimalizaci'" Class="rz-color-base-600" />
                    </RadzenStack>
                </RadzenCard>
            }
            else
            {
                <!-- Graf -->
                <RadzenCard Class="rz-mb-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
                        <RadzenIcon Icon="show_chart" />
                        <RadzenText TextStyle="TextStyle.H5" Text="Ekonomick√° anal√Ωza" />
                    </RadzenStack>

                    <div id="optimizationChartContainer" style="height: 400px; position: relative;">
                        <canvas id="optimizationChart"></canvas>
                    </div>
                </RadzenCard>

                <!-- V√Ωsledky optimalizace -->
                <RadzenCard Class="rz-mb-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
                        <RadzenIcon Icon="check_circle" style="color: var(--rz-success);" />
                        <RadzenText TextStyle="TextStyle.H5" Text="Optim√°ln√≠ ≈ôe≈°en√≠" />
                    </RadzenStack>

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="4" SizeLG="2">
                            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Text="@($"{result.OptimalThickness:F1} cm")" Class="rz-color-primary" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="Tlou≈°≈•ka" Class="rz-color-base-600" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="4" SizeLG="2">
                            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Text="@($"{result.OptimalRValue:F2}")" Class="rz-color-secondary" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="R [m¬≤K/W]" Class="rz-color-base-600" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="4" SizeLG="2">
                            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Text="@($"{result.OptimalUValue:F3}")" Class="rz-color-warning" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="U [W/m¬≤K]" Class="rz-color-base-600" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="4" SizeLG="3">
                            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Text="@($"{result.OptimalPaybackPeriod:F1} let")" Class="rz-color-success" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="N√°vratnost" Class="rz-color-base-600" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="4" SizeLG="3">
                            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Text="@($"{result.OptimalAnnualSavings:F0} Kƒç")" Class="rz-color-info" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="Roƒçn√≠ √∫spora" Class="rz-color-base-600" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <hr style="margin: 1rem 0;" />

                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Outlined" Style="background-color: white; border: 1px solid #dee2e6;">
                        @result.Recommendation
                    </RadzenAlert>
                </RadzenCard>

                <!-- Dodateƒçn√© grafy -->
                <RadzenCard Class="rz-mb-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
                        <RadzenIcon Icon="insert_chart" />
                        <RadzenText TextStyle="TextStyle.H5" Text="Dodateƒçn√© grafy" />
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ShowGraphsInfo">
                            <i class="bi bi-info-circle"></i> Jak grafy funguj√≠
                        </button>
                    </RadzenStack>

                    <!-- Volba zobrazen√Ωch k≈ôivek -->
                    <RadzenFieldset Text="Zobrazit k≈ôivky:">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.75rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenCheckBox TValue="bool" Value="@showPaybackCurve" ValueChanged="@OnPaybackCurveChanged" Name="showPaybackCurve" />
                                <RadzenLabel Text="üîµ Celkov√° n√°vratnost" Component="showPaybackCurve" />
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ShowPaybackInfo">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenCheckBox TValue="bool" Value="@showMarginalPaybackCurve" ValueChanged="@OnMarginalPaybackCurveChanged" Name="showMarginalPaybackCurve" />
                                <RadzenLabel Text="üü† P≈ô√≠r≈Østkov√° n√°vratnost" Component="showMarginalPaybackCurve" />
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ShowMarginalPaybackInfo">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenCheckBox TValue="bool" Value="@showNetProfitCurve" ValueChanged="@OnNetProfitCurveChanged" Name="showNetProfitCurve" />
                                <RadzenLabel Text="üí∞ ƒåist√Ω zisk za ≈æivotnost" Component="showNetProfitCurve" />
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ShowNetProfitInfo">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenCheckBox TValue="bool" Value="@showRoiCurve" ValueChanged="@OnRoiCurveChanged" Name="showRoiCurve" />
                                <RadzenLabel Text="üìà ROI - n√°vratnost investice" Component="showRoiCurve" />
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ShowRoiInfo">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenFieldset>

                    @if (showPaybackCurve || showMarginalPaybackCurve || showNetProfitCurve || showRoiCurve)
                    {

                        <div style="height: 450px; position: relative; margin-top: 1rem;">
                            <canvas id="combinedPaybackChart"></canvas>
                        </div>
                    }
                </RadzenCard>

                <!-- Srovn√°vac√≠ tabulka -->
                <RadzenCard>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
                        <RadzenIcon Icon="compare_arrows" />
                        <RadzenText TextStyle="TextStyle.H5" Text="Srovn√°n√≠ variant" />
                    </RadzenStack>

                    <RadzenDataGrid Data="@comparisonData" TItem="OptimizationDataPoint" AllowPaging="false" AllowSorting="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="Thickness" Title="Tlou≈°≈•ka [cm]">
                                <Template Context="data">
                                    @if (Math.Abs(data.Thickness - result.OptimalThickness) < 0.1)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@($"{data.Thickness:F1} cm")" />
                                    }
                                    else
                                    {
                                        @($"{data.Thickness:F1} cm")
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="RValue" Title="R [m¬≤K/W]" FormatString="{0:F2}" />
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="UValue" Title="U [W/m¬≤K]" FormatString="{0:F3}" />
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="InvestmentCost" Title="Investice [Kƒç/m¬≤]" FormatString="{0:F0}" />
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="AnnualSavings" Title="Roƒçn√≠ √∫spora [Kƒç/m¬≤]" FormatString="{0:F0}" />
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="PaybackPeriod" Title="N√°vratnost [roky]" FormatString="{0:F1}" />
                            <RadzenDataGridColumn TItem="OptimizationDataPoint" Property="NetProfit" FormatString="{0:F0}">
                                <HeaderTemplate>
                                    Zisk za @(result.Input.LifetimeYears) let [Kƒç/m¬≤]
                                </HeaderTemplate>
                                <Template Context="data">
                                    <span style="color: @(data.NetProfit > 0 ? "var(--rz-success)" : "var(--rz-danger)")">
                                        @($"{data.NetProfit:F0} Kƒç")
                                    </span>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenCard>
            }
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private InsulationOptimizationInput input = new();
    private InsulationOptimizationResult? result;
    private List<OptimizationDataPoint> comparisonData = new();
    private List<string> presetNames = new();
    private string? selectedPresetName;
    private List<OptimizationPreset> presets = new();
    private bool showPaybackCurve = false;
    private bool showMarginalPaybackCurve = false;
    private bool showNetProfitCurve = false;
    private bool showRoiCurve = false;

    protected override void OnInitialized()
    {
        presets = OptimizationPreset.GetPresets();
        presetNames = presets.Select(p => p.Name).ToList();
    }

    private void OnPresetChanged()
    {
        if (!string.IsNullOrEmpty(selectedPresetName))
        {
            var preset = presets.FirstOrDefault(p => p.Name == selectedPresetName);
            if (preset != null)
            {
                input.Lambda = preset.Lambda;
                input.InsulationCostPerCm = preset.InsulationCostPerCm;
                input.MaterialName = preset.Name;
            }
        }
    }

    private async Task CalculateOptimization()
    {
        try
        {
            // Vypoƒç√≠tat optimalizaci
            result = OptimizationService.CalculateOptimization(input);

            // Z√≠skat srovn√°vac√≠ data
            comparisonData = OptimizationService.GetComparisonData(result);

            // Vykreslit graf
            await RenderChart();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Chyba p≈ôi v√Ωpoƒçtu: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "Do≈°lo k chybƒõ p≈ôi v√Ωpoƒçtu optimalizace.");
        }
    }

    private async Task RenderChart()
    {
        if (result == null) return;

        // P≈ô√≠prava dat pro Chart.js
        var thicknesses = result.DataPoints.Select(dp => dp.Thickness).ToArray();
        var investmentCosts = result.DataPoints.Select(dp => dp.InvestmentCost).ToArray();
        var cumulativeSavings = result.DataPoints.Select(dp => dp.CumulativeSavings).ToArray();
        var netProfits = result.DataPoints.Select(dp => dp.NetProfit).ToArray();

        var chartData = new
        {
            labels = thicknesses,
            datasets = new object[]
            {
                new
                {
                    label = "Investiƒçn√≠ n√°klady",
                    data = investmentCosts,
                    borderColor = "rgb(255, 99, 132)",
                    backgroundColor = "rgba(255, 99, 132, 0.1)",
                    tension = 0.1,
                    yAxisID = "y"
                },
                new
                {
                    label = $"√öspora za {input.LifetimeYears} let",
                    data = cumulativeSavings,
                    borderColor = "rgb(75, 192, 192)",
                    backgroundColor = "rgba(75, 192, 192, 0.1)",
                    tension = 0.1,
                    yAxisID = "y"
                },
                new
                {
                    label = "ƒåist√Ω zisk",
                    data = netProfits,
                    borderColor = "rgb(54, 162, 235)",
                    backgroundColor = "rgba(54, 162, 235, 0.1)",
                    tension = 0.1,
                    borderWidth = 3,
                    yAxisID = "y"
                }
            }
        };

        await JS.InvokeVoidAsync("renderOptimizationChart", chartData, result.OptimalThickness);
    }

    private async Task OnPaybackCurveChanged(bool value)
    {
        showPaybackCurve = value;
        await RenderCombinedChart();
    }

    private async Task OnMarginalPaybackCurveChanged(bool value)
    {
        showMarginalPaybackCurve = value;
        await RenderCombinedChart();
    }

    private async Task OnNetProfitCurveChanged(bool value)
    {
        showNetProfitCurve = value;
        await RenderCombinedChart();
    }

    private async Task OnRoiCurveChanged(bool value)
    {
        showRoiCurve = value;
        await RenderCombinedChart();
    }

    private async Task RenderCombinedChart()
    {
        if ((!showPaybackCurve && !showMarginalPaybackCurve && !showNetProfitCurve && !showRoiCurve) || result == null) return;

        await Task.Delay(100); // Poƒçkat na vykreslen√≠ canvas elementu

        var thicknesses = result.DataPoints.Select(dp => dp.Thickness).ToArray();

        var datasets = new List<object>();

        // P≈ôidat k≈ôivku celkov√© n√°vratnosti, pokud je za≈°krtnuta
        if (showPaybackCurve)
        {
            var paybackPeriods = result.DataPoints.Select(dp =>
                dp.PaybackPeriod == double.PositiveInfinity ? input.LifetimeYears * 2 : dp.PaybackPeriod
            ).ToArray();

            datasets.Add(new
            {
                label = "Celkov√° n√°vratnost [roky]",
                data = paybackPeriods,
                borderColor = "rgb(54, 162, 235)",
                backgroundColor = "rgba(54, 162, 235, 0.1)",
                tension = 0.3,
                fill = true,
                borderWidth = 3
            });
        }

        // P≈ôidat k≈ôivku p≈ô√≠r≈Østkov√© n√°vratnosti, pokud je za≈°krtnuta
        if (showMarginalPaybackCurve)
        {
            var marginalPaybacks = result.DataPoints.Select(dp => dp.IncrementalPayback).ToArray();

            datasets.Add(new
            {
                label = "P≈ô√≠r≈Østkov√° n√°vratnost [roky]",
                data = marginalPaybacks,
                borderColor = "rgb(255, 159, 64)",
                backgroundColor = "rgba(255, 159, 64, 0.1)",
                tension = 0.3,
                fill = true,
                borderWidth = 3,
                yAxisID = "y"
            });
        }

        // P≈ôidat k≈ôivku ƒçist√©ho zisku za ≈æivotnost, pokud je za≈°krtnuta
        if (showNetProfitCurve)
        {
            var netProfits = result.DataPoints.Select(dp => dp.NetProfit).ToArray();

            datasets.Add(new
            {
                label = "ƒåist√Ω zisk za ≈æivotnost [Kƒç]",
                data = netProfits,
                borderColor = "rgb(75, 192, 192)",
                backgroundColor = "rgba(75, 192, 192, 0.1)",
                tension = 0.3,
                fill = true,
                borderWidth = 3,
                yAxisID = "y1"
            });
        }

        // P≈ôidat k≈ôivku ROI (Return on Investment v procentech), pokud je za≈°krtnuta
        if (showRoiCurve)
        {
            // ROI = (NetProfit / InvestmentCost) √ó 100
            var roiValues = result.DataPoints.Select(dp =>
                dp.InvestmentCost > 0 ? (dp.NetProfit / dp.InvestmentCost) * 100.0 : 0.0
            ).ToArray();

            datasets.Add(new
            {
                label = "ROI - n√°vratnost investice [%]",
                data = roiValues,
                borderColor = "rgb(153, 102, 255)",
                backgroundColor = "rgba(153, 102, 255, 0.1)",
                tension = 0.3,
                fill = true,
                borderWidth = 3,
                yAxisID = "y2"
            });
        }

        var chartData = new
        {
            labels = thicknesses,
            datasets = datasets.ToArray()
        };

        var annotations = new
        {
            lifetimeLine = new
            {
                type = "line",
                yMin = input.LifetimeYears,
                yMax = input.LifetimeYears,
                borderColor = "rgb(255, 99, 132)",
                borderWidth = 2,
                borderDash = new[] { 5, 5 },
                label = new
                {
                    content = $"≈Ωivotnost izolace ({input.LifetimeYears} let)",
                    enabled = true,
                    position = "end"
                }
            },
            optimalPoint = new
            {
                type = "point",
                xValue = result.OptimalThickness,
                yValue = result.OptimalPaybackPeriod,
                backgroundColor = "rgb(75, 192, 192)",
                borderColor = "rgb(75, 192, 192)",
                radius = 10,
                label = new
                {
                    content = $"Optimum: {result.OptimalThickness:F1} cm",
                    enabled = true,
                    position = "top"
                }
            }
        };

        await JS.InvokeVoidAsync("renderCombinedPaybackChart", chartData, annotations);
    }

    private void ShowHelp()
    {
        var content = @"
            <div class='modal-content'>
                <div class='modal-header'>
                    <h5 class='modal-title'>N√°povƒõda - Optimalizace tlou≈°≈•ky izolace</h5>
                    <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
                </div>
                <div class='modal-body'>
                    <h6>Ekonomick√° optimalizace tlou≈°≈•ky izolace</h6>
                    <p>Tato str√°nka vypoƒç√≠t√° ekonomicky optim√°ln√≠ tlou≈°≈•ku izolace pomoc√≠ anal√Ωzy n√°klad≈Ø a √∫spor.</p>

                    <h6 class='mt-3'>Z√°kladn√≠ vzorce:</h6>
                    <ol>
                        <li><strong>Tepeln√Ω odpor izolace:</strong> R = d / Œª
                            <br><small>kde: d = tlou≈°≈•ka [m], Œª = tepeln√° vodivost [W/(m¬∑K)]</small>
                        </li>
                        <li><strong>Souƒçinitel prostupu tepla:</strong> U = 1 / (Rsi + R + Rse)
                            <br><small>kde: Rsi = odpor p≈ôestupu tepla na vnit≈ôn√≠ stranƒõ (0,13 m¬≤K/W) - tepl√Ω vzduch ‚Üí stƒõna</small>
                            <br><small>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rse = odpor p≈ôestupu tepla na vnƒõj≈°√≠ stranƒõ (0,04 m¬≤K/W) - stƒõna ‚Üí venkovn√≠ vzduch</small>
                            <br><small>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R = tepeln√Ω odpor izolace</small>
                        </li>
                        <li><strong>Roƒçn√≠ tepeln√© ztr√°ty:</strong> Q = U √ó ŒîT √ó 24 √ó D / 1000
                            <br><small>kde: ŒîT = rozd√≠l teplot [¬∞C], D = poƒçet otopn√Ωch dn≈Ø, Q = ztr√°ty [kWh/m¬≤/rok]</small>
                        </li>
                        <li><strong>Roƒçn√≠ n√°klady na vyt√°pƒõn√≠:</strong> NC = Q √ó cena_energie [Kƒç/m¬≤/rok]</li>
                        <li><strong>Investiƒçn√≠ n√°klady:</strong> IC = fixn√≠_n√°klady + d √ó cena_za_cm [Kƒç/m¬≤]</li>
                        <li><strong>Roƒçn√≠ √∫spora oproti nezateplen√©mu stavu:</strong> √öspora = NC(bez_izolace) - NC(s_izolac√≠)</li>
                        <li><strong>Doba n√°vratnosti:</strong> DN = IC / roƒçn√≠_√∫spora [roky]</li>
                        <li><strong>ƒåist√Ω zisk za ≈æivotnost:</strong> Zisk = celkov√°_√∫spora - IC [Kƒç/m¬≤]</li>
                    </ol>

                    <h6 class='mt-3'>Postup v√Ωpoƒçtu:</h6>
                    <ol>
                        <li>Pro ka≈ædou tlou≈°≈•ku (1-50 cm) se vypoƒç√≠t√°:
                            <ul>
                                <li>Tepeln√Ω odpor R a souƒçinitel U</li>
                                <li>Roƒçn√≠ tepeln√© ztr√°ty</li>
                                <li>Investiƒçn√≠ n√°klady</li>
                                <li>Roƒçn√≠ √∫spora energie</li>
                                <li>Doba n√°vratnosti</li>
                                <li>ƒåist√Ω zisk za dobu ≈æivotnosti</li>
                            </ul>
                        </li>
                        <li>Optim√°ln√≠ tlou≈°≈•ka = <strong>maximum ƒçist√©ho zisku</strong> (ne nejkrat≈°√≠ n√°vratnost!)</li>
                        <li>Zohlednƒõn√≠ inflace (volitelnƒõ): Celkov√°_√∫spora = Œ£(√∫spora_rok_1 √ó (1 + i)^n)
                            <br><small>kde: i = roƒçn√≠ inflace, n = rok</small>
                        </li>
                    </ol>

                    <h6 class='mt-3'>Graf:</h6>
                    <ul>
                        <li><span style='color: red;'>‚óè</span> <strong>ƒåerven√° k≈ôivka:</strong> Investiƒçn√≠ n√°klady (rostou line√°rnƒõ s tlou≈°≈•kou)</li>
                        <li><span style='color: green;'>‚óè</span> <strong>Zelen√° k≈ôivka:</strong> Celkov√° √∫spora za ≈æivotnost (roste, ale zpomaluje)</li>
                        <li><span style='color: blue;'>‚óè</span> <strong>Modr√° k≈ôivka:</strong> ƒåist√Ω zisk (zelen√° - ƒçerven√°)</li>
                    </ul>
                    <p><strong>‚Üí Optim√°ln√≠ bod je tam, kde je MODR√Å k≈ôivka nejvy≈°≈°√≠!</strong></p>

                    <h6 class='mt-3'>Pozn√°mky:</h6>
                    <ul>
                        <li>Tlust≈°√≠ izolace = vƒõt≈°√≠ investice, ale men≈°√≠ √∫spora energie</li>
                        <li>Po urƒçit√© tlou≈°≈•ce u≈æ dal≈°√≠ izolace nen√≠ ekonomick√°</li>
                        <li>V√Ωsledky jsou orientaƒçn√≠ - konzultujte projektanta</li>
                        <li>Nezohled≈àuje: dotace, cenu nemovitosti, ekologii</li>
                    </ul>
                </div>
                <div class='modal-footer'>
                    <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
                </div>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }

    // Metody pro zobrazen√≠ help modal≈Ø pro grafy
    private void ShowGraphsInfo()
    {
        var content = @"
            <div class='modal-header'>
                <h5 class='modal-title'><i class='bi bi-graph-up'></i> Jak grafy funguj√≠</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
            </div>
            <div class='modal-body'>
                <h6>üí° Legenda graf≈Ø</h6>
                <ul>
                    <li><strong>üü¢ Zelen√Ω bod:</strong> Ekonomicky optim√°ln√≠ tlou≈°≈•ka = m√≠sto s maxim√°ln√≠m ƒçist√Ωm ziskem za celou ≈æivotnost izolace</li>
                    <li><strong>üî¥ ƒåerven√° ƒç√°ra:</strong> Maxim√°ln√≠ ≈æivotnost izolace. Body nad touto ƒçarou znamenaj√≠, ≈æe investice se nesplat√≠ bƒõhem ≈æivotnosti.</li>
                </ul>
                <p class='mt-3'><em>‚ö†Ô∏è Pozor: Optimum NEN√ç v pr≈Øseƒç√≠ku k≈ôivek! Hled√°me maximum zisku, ne nejkrat≈°√≠ n√°vratnost.</em></p>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }

    private void ShowPaybackInfo()
    {
        var content = @"
            <div class='modal-header'>
                <h5 class='modal-title'><i class='bi bi-clock-history'></i> Celkov√° n√°vratnost</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
            </div>
            <div class='modal-body'>
                <h6>Co je celkov√° n√°vratnost?</h6>
                <p>Doba, za kterou se vr√°t√≠ <strong>celkov√° investice</strong> do zateplen√≠ dan√© tlou≈°≈•ky.</p>

                <h6>Interpretace grafu:</h6>
                <ul>
                    <li>ƒå√≠m tlust≈°√≠ izolace, t√≠m <strong>vƒõt≈°√≠ investice</strong></li>
                    <li>Ale tak√© <strong>men≈°√≠ √∫spora energie</strong> (klesaj√≠c√≠ mezn√≠ p≈ô√≠nosy)</li>
                    <li>Proto doba n√°vratnosti s rostouc√≠ tlou≈°≈•kou <strong>roste</strong></li>
                </ul>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }

    private void ShowMarginalPaybackInfo()
    {
        var content = @"
            <div class='modal-header'>
                <h5 class='modal-title'><i class='bi bi-bar-chart-steps'></i> P≈ô√≠r≈Østkov√° n√°vratnost</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
            </div>
            <div class='modal-body'>
                <h6>Co je p≈ô√≠r≈Østkov√° n√°vratnost?</h6>
                <p>Doba n√°vratnosti investice do <strong>KA≈ΩD√âHO DAL≈†√çHO centimetru</strong> izolace (margin√°ln√≠ anal√Ωza).</p>

                <h6>Interpretace grafu:</h6>
                <ul>
                    <li><strong>Prvn√≠ centimetry</strong> se vyplat√≠ velmi rychle</li>
                    <li><strong>Dal≈°√≠ centimetry</strong> pomaleji (klesaj√≠c√≠ mezn√≠ u≈æitek)</li>
                    <li>Kdy≈æ k≈ôivka <strong>p≈ôekroƒç√≠ ƒçervenou ƒç√°ru</strong>, dal≈°√≠ izolace u≈æ je neefektivn√≠ (nesplat√≠ se bƒõhem ≈æivotnosti)</li>
                </ul>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }

    private void ShowNetProfitInfo()
    {
        var content = @"
            <div class='modal-header'>
                <h5 class='modal-title'><i class='bi bi-cash-coin'></i> ƒåist√Ω zisk za ≈æivotnost</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
            </div>
            <div class='modal-body'>
                <h6>Co je ƒçist√Ω zisk?</h6>
                <p>Celkov√° √∫spora za celou ≈æivotnost izolace <strong>MINUS</strong> poƒç√°teƒçn√≠ investice.</p>

                <h6>Vzorec:</h6>
                <p><code>ƒåist√Ω zisk = (Roƒçn√≠ √∫spora √ó ≈Ωivotnost) - Investice</code></p>

                <h6>Interpretace hodnot:</h6>
                <ul>
                    <li><strong>&gt; 0 Kƒç:</strong> Investice je ziskov√°</li>
                    <li><strong>= 0 Kƒç:</strong> Break-even (n√°vratnost p≈ôesnƒõ na konci ≈æivotnosti)</li>
                    <li><strong>&lt; 0 Kƒç:</strong> Ztr√°ta (investice se nevyplat√≠)</li>
                </ul>
                <p class='mt-2'><em>ƒå√≠m vy≈°≈°√≠ hodnota, t√≠m v√Ωhodnƒõj≈°√≠ investice!</em></p>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }

    private void ShowRoiInfo()
    {
        var content = @"
            <div class='modal-header'>
                <h5 class='modal-title'><i class='bi bi-percent'></i> ROI - Return on Investment</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
            </div>
            <div class='modal-body'>
                <h6>Co je ROI?</h6>
                <p>N√°vratnost investice v procentech - ukazuje, kolik procent ze sv√© investice z√≠sk√°te zpƒõt za celou ≈æivotnost.</p>

                <h6>Vzorec:</h6>
                <p><code>ROI = (ƒåist√Ω zisk / Investice) √ó 100%</code></p>

                <h6>Interpretace hodnot:</h6>
                <ul>
                    <li><strong>ROI 200%:</strong> V√Ωjimeƒçn√° n√°vratnost (3√ó investice)</li>
                    <li><strong>ROI 100%:</strong> Zdvojn√°soben√≠ investice</li>
                    <li><strong>ROI 50%:</strong> Z√≠sk√°te 1.5√ó investice zpƒõt</li>
                    <li><strong>ROI 0%:</strong> Break-even (jen vr√°t√≠ investici)</li>
                    <li><strong>ROI &lt; 0%:</strong> Ztr√°ta</li>
                </ul>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Zav≈ô√≠t</button>
            </div>";

        JS.InvokeVoidAsync("showModal", "infoModal", content);
    }
}
